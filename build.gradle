//file:noinspection GroovyUnusedCatchParameter

import java.nio.file.Files
import java.nio.file.Paths

import static java.lang.System.getenv

buildscript {
    repositories {
        mavenCentral()

        maven {
            url = "https://oss.sonatype.org/content/repositories/snapshots/"
            name = "sonatype"
        }

        maven {
            url = "https://maven.atlassian.com/3rdparty/"
        }

        google()
    }

    dependencies {
        classpath group: 'commons-io', name: 'commons-io', version: '2.8.0'
        classpath "com.google.code.gson:gson:2.8.9"
    }
}

//*****************//
//     Plugins     //
//*****************//
plugins {
    id 'java'
    id 'java-library'
    id 'maven-publish'
}

apply plugin: 'java'
apply plugin: 'java-library'
apply plugin: 'maven-publish'
apply plugin: 'bubbles-gradle'

//****************************//
// Setting up main properties //
//****************************//
def calendar = Calendar.getInstance()
def date = String.format("%01dy%02dm%02dd", calendar.get(Calendar.YEAR) - 2000, calendar.get(Calendar.MONTH), calendar.get(Calendar.DAY_OF_MONTH))
def time = String.format("%01dh%02dm%02ds", calendar.get(Calendar.HOUR_OF_DAY), calendar.get(Calendar.MINUTE), calendar.get(Calendar.SECOND))

version "${project_version}+${getenv("GITHUB_BUILD_NUMBER") == null ? "$date+$time" : getenv("GITHUB_BUILD_NUMBER")}"
group 'com.ultreon' // http://maven.apache.org/guides/mini/guide-naming-conventions.html

java {
    withSourcesJar()
    withJavadocJar()
}

task deleteOldJavadoc(type: Delete) {
    delete fileTree("$projectDir/docs/latest/")
}

task copyJavadoc(type: Copy) {
    from javadoc.outputs
    into "$projectDir/docs/latest/"
    dependsOn deleteOldJavadoc
}

mkdir "$projectDir/docs/"
mkdir "$projectDir/docs/latest"

javadoc.finalizedBy(copyJavadoc)

//**********************//
//     Repositories     //
//**********************//
repositories {
    mavenCentral()
    mavenLocal()
    google()
    jcenter()
    maven {
        name "Atlassian"
        url "https://maven.atlassian.com/3rdparty/"
    }
    maven {
        name "ImageJ"
        url "https://maven.imagej.net/content/repositories/public/"
    }
    maven {
        name "Maven Central"
        url "https://repo1.maven.org/maven2/"
    }
    maven {
        name "RuneLite"
        url "https://repo.runelite.net/"
    }
    maven {
        name "JitPack"
        url 'https://jitpack.io'
    }
    flatDir {
        name "Project Libraries"
        dirs "${projectDir}/libs"
    }
}

/*****************
 * Configurations
 */
configurations {
    // configuration that holds jars to include in the jar
    api {
        canBeResolved true
    }
}

/***************
 * Dependencies
 */
dependencies {
    // Projects
    api project(":preloader")
    api 'it.unimi.dsi:fastutil:8.5.9'
    api 'it.unimi.dsi:fastutil-extra:8.5.4'
    api 'it.unimi.dsi:fastutil-core:8.5.9'
    api 'org.checkerframework:checker:3.25.0'

    // Test dependencies
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.9.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.9.0'

    // Misc
    api 'org.jetbrains:annotations:23.0.0'

    // Apis
    api 'commons-io:commons-io:2.11.0'
    api 'org.apache.commons:commons-lang3:3.12.0'
    api 'org.apache.commons:commons-collections4:4.4'
    api 'org.apache.commons:commons-text:1.10.0'
    api 'org.apache.ant:ant:1.10.12'

    //noinspection GradlePackageUpdate
    api 'commons-lang:commons-lang:2.6'

    // Local jars.
    api fileTree(dir: '.\\libs', include: ['*.jar'])

    // Google
    api group: 'com.google.code.findbugs', name: 'jsr305', version: '3.0.2'
    api group: 'com.google.guava', name: 'guava', version: '31.0.1-jre'
    api group: 'com.google.code.gson', name: 'gson', version: '2.9.0'

    // Apache
    api group: 'org.apache.logging.log4j', name: 'log4j', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-slf4j-impl', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-jcl', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-jul', version: '2.14.1'
    api group: 'org.apache.logging.log4j', name: 'log4j-web', version: '2.14.1'
    api group: 'org.apache.xmlgraphics', name: 'batik-svg-dom', version: '1.14'
    api group: 'org.apache.xmlgraphics', name: 'batik-dom', version: '1.14'
    api group: 'org.apache.xmlgraphics', name: 'batik-all', version: '1.14'
    api group: 'org.apache.xmlgraphics', name: 'batik-util', version: '1.14'
    api group: 'org.apache.xmlgraphics', name: 'batik-swing', version: '1.14'
    api group: 'org.apache.xmlgraphics', name: 'batik-awt-util', version: '1.14'

    // JHLabs
    api group: 'com.jhlabs', name: 'filters', version: '2.0.235-1'

    // SwingLabs
    api group: 'org.swinglabs.swingx', name: 'swingx-all', version: '1.6.5-1'

    // FuseSource
    api group: 'org.fusesource.jansi', name: 'jansi', version: '2.3.4'

    // OpenJFX
    api 'org.openjfx:javafx-swing:19'
    api 'org.openjfx:javafx-media:19'
    api 'org.openjfx:javafx-controls:19'
    api 'org.openjfx:javafx-graphics:19'
    api 'org.openjfx:javafx:19'

    // OpenJFX Natives
    api 'org.openjfx:javafx-swing:19:win'
    api 'org.openjfx:javafx-swing:19:mac'
    api 'org.openjfx:javafx-swing:19:linux'
    api 'org.openjfx:javafx-media:19:win'
    api 'org.openjfx:javafx-media:19:mac'
    api 'org.openjfx:javafx-media:19:linux'
    api 'org.openjfx:javafx-controls:19:win'
    api 'org.openjfx:javafx-controls:19:mac'
    api 'org.openjfx:javafx-controls:19:linux'
    api 'org.openjfx:javafx-graphics:19:win'
    api 'org.openjfx:javafx-graphics:19:mac'
    api 'org.openjfx:javafx-graphics:19:linux'
    api 'org.openjfx:javafx-base:19:win'
    api 'org.openjfx:javafx-base:19:mac'
    api 'org.openjfx:javafx-base:19:linux'

    // MongoDB
    api group: 'org.mongodb', name: 'bson', version: '4.3.2'

    // OSHi (For system info in crash reports)
    api 'com.github.oshi:oshi-core:6.3.0'

    // Discord Presence
    api 'com.github.JnCrMx:discord-game-sdk4j:v0.5.5'

    // MP3 Sounds
    api group: 'javazoom', name: 'jlayer', version: '1.0.1'

    // Apache commons
    api group: 'org.apache.commons', name: 'commons-math3', version: '3.6.1'
}

allprojects {
    apply plugin: "bubbles-gradle"
    apply plugin: "maven-publish"
    apply plugin: "java"
    apply plugin: "java-library"
    apply plugin: "idea"
    apply plugin: "groovy"

    publishing {
        publications {
            mavenJava(MavenPublication) {
            }
        }
        repositories {
            maven {
                name = "GitHubPackages"
                url = "https://maven.pkg.github.com/Ultreon/bubble-blaster-2"
                credentials {
                    username = getenv("GITHUB_ACTOR")
                    password = getenv("GITHUB_TOKEN")
                }
            }
        }
    }

    publish.dependsOn build
    publish.finalizedBy(it.retrieveUrls)
}

// task to add addons.json to all relevant folders
task replaceResources(type: Copy) {
    from("src/main/resources/META-INF/addons.json")
    outputs.upToDateWhen {
        false
    }

    filter { line -> line.replaceAll('\\\$\\\$ADDON_VERSION\\\$\\\$', version.toString()) }
    into new File(processResources.destinationDir, "META-INF")
}

processResources {
    exclude 'META-INF/addons.json'
    finalizedBy replaceResources
}

jar {
    dependsOn ":preloader:jar"

    //noinspection GroovyAssignabilityCheck
    manifest {
        //noinspection GroovyAssignabilityCheck
        attributes 'Implementation-Title': 'QBubbles',
                'Implementation-Vendor': 'Ultreon Team',
                'Implementation-Version': "1.0-indev1",
                'Main-Class': 'com.ultreon.preloader.PreGameLoader',
                'Multi-Release': 'true'
    }

    from {
        compileJava.outputs
    }
    from {
        processResources.outputs
    }

    zip64 true
    duplicatesStrategy DuplicatesStrategy.INCLUDE
}

mkdir("build/lib-out")

(configurations.api).collect { File file ->
    copy { from file; into "${projectDir}/build/lib-out" }
}

processResources {
    duplicatesStrategy DuplicatesStrategy.INCLUDE
}

test {
    useJUnitPlatform()
}

tasks.create('prepareRun', {
    Files.createDirectories(Paths.get(projectDir.getAbsolutePath(), "run"))
})

tasks.withType(JavaCompile).configureEach {
    options.fork = true
    options.incremental = true
}

tasks.withType(ProcessResources).configureEach {
    duplicatesStrategy DuplicatesStrategy.INCLUDE
}

tasks.withType(Jar).configureEach {
    duplicatesStrategy DuplicatesStrategy.INCLUDE
}

task portableJar(type: Jar) {
    //noinspection GroovyAssignabilityCheck
    manifest {
        //noinspection GroovyAssignabilityCheck
        attributes 'Implementation-Title': 'QBubbles',
                'Implementation-Vendor': 'Ultreon Team',
                'Implementation-Version': "1.0-indev1",
                'Main-Class': 'com.ultreon.preloader.PreGameLoader',
                'Multi-Release': 'true'
    }
    from {
        (rootProject.getSubprojects()).collect {
            zipTree(it.getTasks().getByName("jar").archiveFile.get())
        }
    }
    from {
        (configurations.api).collect {
            it.getPath().startsWith(projectDir.getPath()) ? [] : it.isDirectory() ? it : zipTree(it)
        }
    }
    from jar.archiveFile.get()
    classifier "portable"
    zip64 true
    duplicatesStrategy DuplicatesStrategy.INCLUDE
}

def dependsDir = file("${projectDir}/build/dependencies")

task createExec {
    doFirst {
        if (!file("build").exists()) {
            mkdir "build"
        }
        mkdir "build/exec/"
        if (file("build/exec/lib/").exists()) {
            delete fileTree("build/exec/lib/")
        }
        copy {
            from file("bin/start.bat")
            into file("build/exec/")
        }
        copy {
            from file("bin/start-unix.sh")
            into file("build/exec/")
        }
        copy {
            from file("bin/start-mac.sh")
            into file("build/exec/")
        }
        copy {
            from jar.outputs.files.singleFile
            into file("build/exec/")
            rename ".*", "bubbles.jar"
        }
        mkdir "build/exec/lib/"
        copy {
            from fileTree("build/dependencies/")
            into file("build/exec/lib/")
        }
    }
}

artifacts {
    portableJar
}

jar.finalizedBy(retrieveUrls)
publish.finalizedBy(retrieveUrls)

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8' // Use the UTF-8 charset for Java compilation
}

println('Java: ' + System.getProperty('java.version') + ' JVM: ' + System.getProperty('java.vm.version') + '(' + System.getProperty('java.vendor') + ') Arch: ' + System.getProperty('os.arch'))
println("OS: " + System.getProperty("os.name") + " Version: " + System.getProperty("os.version"))

println("Current version: " + version)
println("Project: " + group + ":" + archivesBaseName)
println("Bulding a Java " + compileJava.targetCompatibility + " project...")
